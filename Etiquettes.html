<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√âtiquettes - Ordi Gesco</title>
  <style>
    /* Styles g√©n√©raux */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .menu-flottant {
      position: fixed;
      top: 0;
      width: 100%;
      background: #0056b3;
      color: white;
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }
    .menu-flottant h1 {
      flex-basis: 100%;
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
      color: white;
    }
    .menu-flottant section {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .menu-flottant label,
    .menu-flottant input,
    .menu-flottant select,
    .menu-flottant button {
      margin-right: 10px;
      font-size: 14px;
    }
    .menu-flottant input[type="radio"] {
      margin-right: 5px;
    }
    .menu-flottant input,
    .menu-flottant select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .menu-flottant button {
      background: #003d7a;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .menu-flottant button:hover {
      background: #002a54;
    }
    .page {
      width: 216mm;
      height: 279mm;
      border: 1px solid #ddd;
      margin: 120px auto 0;
      position: relative;
      background: #f9f9f9;
    }
    .grille {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: linear-gradient(to right, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
      background-size: 10mm 10mm;
      z-index: -1;
      pointer-events: none;
    }
    .etiquette {
      width: 100mm;
      height: 30mm;
      position: absolute;
      border: 1px dashed #0056b3;
      background: #fff;
      padding: 5px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
    }

    /* Style sp√©cifique pour chaque ligne */
    .etiquette .ligne-1 {
      font-size: 18px;
      font-style: italic;  /* Applique l'italique */
      font-weight: bold;   /* Applique le gras */
      width: 90%;
      margin-bottom: 5px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .etiquette .ligne-2 {
      font-size: 16px;
      width: 90%;
      margin-bottom: 5px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .etiquette .ligne-3 {
      font-size: 16px;
      width: 90%;
      margin-bottom: 5px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Masquer les cases √† cocher */
    .etiquette input[type="checkbox"] {
      position: absolute;
      top: -20px;
      left: -20px;
      transform: scale(2);
    }
    .etiquette.locked {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .cadenas {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 18px;
      background: none;
      border: none;
    }
    
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #777;
    }
    .menu-contextuel button {
      background: #0056b3;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .menu-contextuel button:hover {
      background: #003d7a;
    }
    @media print {
    /* Cacher tous les √©l√©ments sauf la page des √©tiquettes */
    body * {
      visibility: hidden;
    }

    /* Rendre visibles uniquement les √©tiquettes sur la page */
    .page, .page * {
      visibility: visible;
    }

    /* Supprimer les styles inutiles pour les champs de texte */
    .etiquette input[type="text"],
    .etiquette select {
      outline: none;         /* Supprime le contour */
      border: none;          /* Supprime les bordures */
      background: none;      /* Supprime l'arri√®re-plan */
      font-size: inherit;    /* Applique la taille de police d√©finie */
      font-style: inherit;   /* Applique le style de police d√©fini */
      font-weight: inherit;  /* Applique l'√©paisseur de police d√©finie */
      color: inherit;        /* Applique la couleur d√©finie */
      width: auto;           /* Adapte la largeur au contenu */
    }

    /* Transformer les menus d√©roulants en texte brut */
    .etiquette select {
      display: none; /* Cacher les menus d√©roulants */
    }

    /* Supprimer les bordures et l'arri√®re-plan des √©tiquettes */
    .etiquette {
      border: none;
      background: none;
    }

    /* Cacher les cadenas */
    .etiquette .cadenas {
      display: none;
    }

    /* Ajouter un span temporaire pour afficher la valeur des menus d√©roulants */
    .etiquette select::after {
      content: attr(data-value); /* Utilise la valeur s√©lectionn√©e comme contenu */
      display: inline-block;
      visibility: visible;
      font-size: inherit;
      font-weight: inherit;
      font-style: inherit;
      color: inherit;
    }

    /* Cacher les cases √† cocher */
    .etiquette input[type="checkbox"] {
      display: none;
    }

    
    /* Cacher le menu flottant, les boutons, etc. */
    footer,
    .menu-flottant,
    .menu-contextuel {
      display: none;
    }

    /* Ajuster la mise en page pour l'impression */
    .page {
      margin: 0;
      padding: 0;
      border: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;  /* Prend toute la largeur */
      height: auto; /* Ajuste la hauteur en fonction du contenu */
    }
  }
    
    .option-class {
    width: 90%;
    padding: 5px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 5px;
  }
  </style>
</head>
<body>
  <div class="menu-flottant">
    <button id="lock-toggle">üîí Verrouiller</button>
    <button onclick="printLabels()">Imprimer les √©tiquettes</button>
  </div>

  
  <!-- Menu Flottant -->
  <div class="menu-flottant" id="menu-flottant">
    <h1>Test Etiquettes</h1>
    <section>
      <label for="width">Largeur :</label>
      <input type="number" id="width" value="100" min="50" max="200">
      <label for="height">Hauteur :</label>
      <input type="number" id="height" value="30" min="20" max="100">
      <label for="font-size">Police :</label>
      <input type="number" id="font-size" value="14" min="8" max="24">
    </section>
    <section>
      <label for="top">Vertical :</label>
      <input type="number" id="top" min="0" max="279">
      <label for="left">Horizontal :</label>
      <input type="number" id="left" min="0" max="216">
      <button onclick="applyPosition()">Appliquer</button>
    </section>
    <section>
      <label for="grille">Grille :</label>
      <input type="radio" id="grille-on" name="grille" checked onclick="toggleGrille(true)"> Activ√©e
      <input type="radio" id="grille-off" name="grille" onclick="toggleGrille(false)"> D√©sactiv√©e
    </section>
    <section>
      <button onclick="undoAction()">Annuler</button>
      <button onclick="saveLabels()">Sauvegarder</button>
      <button onclick="loadLabels()">Charger</button>
      <button onclick="resetPositions()">R√©initialiser</button>
      <button onclick="printLabels()">Imprimer</button>
    </section>
  </div>

  <div class="menu-flottant">
    <button onclick="toggleContextMenu()">‚ò∞ Menu</button>
    <button onclick="printLabels()">üñ®Ô∏è Imprimer</button>
    <button id="lock-toggle" onclick="toggleLockAll()">üîí Verrouiller tout</button>
  </div>

  <!-- 5 √âtiquettes par d√©faut -->
  <div class="page" id="page">
      <div class="etiquette locked" data-id="1" style="top: 24mm; left: 80mm;">
        <button class="cadenas" onclick="toggleLock(this)">üîí</button>
        <input type="checkbox">
        <input type="text" placeholder="Ligne 1" class="ligne-1">
        <select class="ligne-2 option-class" onchange="handleSelectChange(this)"></select>
        <input type="text" placeholder="Ligne 3" class="ligne-3">
      </div>
      <!-- R√©p√©t√© pour les autres √©tiquettes sans duplication excessive -->
      <div class="etiquette locked" data-id="2" style="top: 74mm; left: 80mm;">
        <button class="cadenas" onclick="toggleLock(this)">üîí</button>
        <input type="checkbox">
        <input type="text" placeholder="Ligne 1" class="ligne-1">
        <select class="ligne-2 option-class" onchange="handleSelectChange(this)"></select>
        <input type="text" placeholder="Ligne 3" class="ligne-3">
      </div>
      <div class="etiquette locked" data-id="3" style="top: 129mm; left: 80mm;">
        <button class="cadenas" onclick="toggleLock(this)">üîí</button>
        <input type="checkbox">
        <input type="text" placeholder="Ligne 1" class="ligne-1">
        <select class="ligne-2 option-class" onchange="handleSelectChange(this)"></select>
        <input type="text" placeholder="Ligne 3" class="ligne-3">
      </div>
      <div class="etiquette locked" data-id="4" style="top: 183mm; left: 80mm;">
        <button class="cadenas" onclick="toggleLock(this)">üîí</button>
        <input type="checkbox">
        <input type="text" placeholder="Ligne 1" class="ligne-1">
        <select class="ligne-2 option-class" onchange="handleSelectChange(this)"></select>
        <input type="text" placeholder="Ligne 3" class="ligne-3">
      </div>
      <div class="etiquette locked" data-id="5" style="top: 224mm; left: 80mm;">
        <button class="cadenas" onclick="toggleLock(this)">üîí</button>
        <input type="checkbox">
        <input type="text" placeholder="Ligne 1" class="ligne-1">
        <select class="ligne-2 option-class" onchange="handleSelectChange(this)"></select>
        <input type="text" placeholder="Ligne 3" class="ligne-3">
      </div>
    </div>
  </div>

  <footer>
    ¬© 2024 Ordi Gesco - Gestion des √âtiquettes
  </footer>

  <script>
    /* VARIABLES GLOBALES */
    let lastAction = null;
    let currentEtiquette = null;
    let isMovable = false;
    let drag = null;
    let backupDropdowns = [];
    let isLocked = true; // D√©placement d√©sactiv√© par d√©faut

    window.onbeforeprint = prepareForPrint;


    const options = [
      "Amortissement", "FPA", "Avis", "Cotisation", "Comit√© Paritaire",
      "Compte √† payer", "Conciliation bancaire", "D√©p√¥t", "D√©p√¥t Chase",
      "Divers", "√âtats financiers mensuels", "Fin d'ann√©e", "NEW",
      "Paie", "TPS - TVQ", "Personnalis√©"
    ];

    /* INITIALISATION DES DROPDOWNS */
    document.addEventListener("DOMContentLoaded", () => {
      const dropdowns = document.querySelectorAll(".ligne-2");
      dropdowns.forEach(dropdown => {
        options.forEach(option => {
          const opt = document.createElement("option");
          opt.value = option;
          opt.textContent = option;
          dropdown.appendChild(opt);
        });
      });
    });

    document.querySelectorAll('.etiquette input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', updatePositionFields);
    });

    function applyPosition() {
      const checkboxes = document.querySelectorAll('.etiquette input[type="checkbox"]:checked');
      const topValue = document.getElementById('top').value;
      const leftValue = document.getElementById('left').value;

      // Appliquer la nouvelle position √† chaque √©tiquette coch√©e
      checkboxes.forEach(checkbox => {
        const etiquette = checkbox.closest('.etiquette');
        etiquette.style.top = `${topValue}px`;
        etiquette.style.left = `${leftValue}px`;
      });
    }

    function updatePositionFields() {
      const checkboxes = document.querySelectorAll('.etiquette input[type="checkbox"]:checked');
      const topField = document.getElementById('top');
      const leftField = document.getElementById('left');

      if (checkboxes.length > 0) {
        const etiquette = checkboxes[0].closest('.etiquette'); // Premi√®re √©tiquette coch√©e
        const top = parseInt(etiquette.style.top, 10);
        const left = parseInt(etiquette.style.left, 10);

        // Mettre √† jour les champs avec la position de la premi√®re √©tiquette coch√©e
        topField.value = isNaN(top) ? '' : top;
        leftField.value = isNaN(left) ? '' : left;
      } else {
        // Si aucune √©tiquette n'est s√©lectionn√©e
        topField.value = '';
        leftField.value = '';
      }
    }

    /* VERROUILLAGE / D√âVERROUILLAGE DES √âTIQUETTES */
    function toggleLock(button) {
      const etiquette = button.parentElement;
      if (etiquette.classList.contains('locked')) {
        etiquette.classList.remove('locked');
        etiquette.style.cursor = 'move';
        etiquette.style.opacity = '1';
        button.textContent = 'üîì';
      } else {
        etiquette.classList.add('locked');
        etiquette.style.cursor = 'not-allowed';
        etiquette.style.opacity = '0.6';
        button.textContent = 'üîí';
      }
    }

    /* D√âPLACEMENT DES √âTIQUETTES */
    document.addEventListener('mousedown', e => {
      if (e.target.closest('.etiquette') && !e.target.closest('.etiquette').classList.contains('locked')) {
        drag = e.target.closest('.etiquette');
        drag.dataset.startX = e.clientX;
        drag.dataset.startY = e.clientY;
        drag.dataset.offsetTop = parseInt(drag.style.top) || 0;
        drag.dataset.offsetLeft = parseInt(drag.style.left) || 0;
      }
    });

    /* D√âPLACEMENT DES √âTIQUETTES */
    document.addEventListener('mousedown', e => {
      if (e.target.closest('.etiquette') && !e.target.closest('.etiquette').classList.contains('locked')) {
        drag = e.target.closest('.etiquette');
        drag.dataset.startX = e.clientX;
        drag.dataset.startY = e.clientY;
        drag.dataset.offsetTop = parseInt(drag.style.top) || 0;
        drag.dataset.offsetLeft = parseInt(drag.style.left) || 0;
      }
    });

    document.addEventListener('mousemove', e => {
      if (drag) {
        const deltaX = e.clientX - drag.dataset.startX;
        const deltaY = e.clientY - drag.dataset.startY;
        drag.style.top = `${parseInt(drag.dataset.offsetTop) + deltaY}px`;
        drag.style.left = `${parseInt(drag.dataset.offsetLeft) + deltaX}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      drag = null;
    });

    /* FONCTIONS POUR G√âRER LES DROPDOWNS */
    function prepareForPrint() {
      const dropdowns = document.querySelectorAll('.ligne-2');
      backupDropdowns = [];

      dropdowns.forEach(selectElement => {
        const value = selectElement.value || ''; // R√©cup√©rer la valeur s√©lectionn√©e
        const span = document.createElement('span');
        span.textContent = value; // Remplacer par la valeur s√©lectionn√©e
        span.style.fontSize = '16px'; // Appliquer le style texte brut
        selectElement.parentNode.replaceChild(span, selectElement);
        backupDropdowns.push({ span, selectElement }); // Sauvegarder pour la restauration
      });
    }

    function restoreDropdowns() {
      backupDropdowns.forEach(({ span, selectElement }) => {
        span.parentNode.replaceChild(selectElement, span);
      });
      backupDropdowns = [];
    }

    window.onbeforeprint = prepareForPrint;
    window.onafterprint = restoreDropdowns;

    function saveLabels() {
      const etiquettes = [...document.querySelectorAll('.etiquette')].map(etiquette => ({
        id: etiquette.dataset.id,
        top: etiquette.style.top,
        left: etiquette.style.left,
        text: [...etiquette.querySelectorAll('input[type="text"]')].map(input => input.value)
      }));
      const blob = new Blob([JSON.stringify(etiquettes)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'etiquettes.json';
      link.click();
    }

    function loadLabels() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            const data = JSON.parse(reader.result);
            data.forEach(item => {
              const etiquette = document.querySelector(`.etiquette[data-id="${item.id}"]`) || addEtiquette();
              etiquette.dataset.id = item.id;
              etiquette.style.top = item.top;
              etiquette.style.left = item.left;
              [...etiquette.querySelectorAll('input[type="text"]')].forEach((input, i) => {
                input.value = item.text[i] || '';
              });
            });
          };
          reader.readAsText(file);
        }
      });
      input.click();
    }


    /* IMPRESSION */
    function printLabels() {
      const etiquettes = document.querySelectorAll('.etiquette');
      const etiquettesToPrint = [];

      // Pr√©parer les √©tiquettes coch√©es pour l'impression
      etiquettes.forEach(etiquette => {
        if (etiquette.querySelector('input[type="checkbox"]').checked) {
          etiquettesToPrint.push(etiquette); // Ajouter les √©tiquettes coch√©es √† une liste temporaire
        } else {
          etiquette.style.display = 'none'; // Masquer les √©tiquettes non coch√©es
        }
      });

      // Transformer les menus d√©roulants en texte brut
      prepareForPrint();

      // Forcer une mise √† jour DOM avant l'impression
      requestAnimationFrame(() => {
        window.print(); // Lancer l'impression

        // Restaurer apr√®s impression
        restoreDropdowns();
        etiquettes.forEach(etiquette => {
          etiquette.style.display = 'block'; // R√©afficher toutes les √©tiquettes
        });
      });
    }

  </script>
</body>
</html>
