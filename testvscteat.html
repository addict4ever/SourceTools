<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur CSV avec Options Avanc√©es</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        td.editable {
            background-color: #f9f9f9;
        }
        input[type="file"], input[type="text"], select, button {
            margin: 10px 5px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .color-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 5px;
            cursor: pointer;
        }
        .color-red { background-color: #FF6347; } /* Rouge */
        .color-blue { background-color: #1E90FF; } /* Bleu */
        .color-green { background-color: #32CD32; } /* Vert */
        .color-yellow { background-color: #FFD700; } /* Jaune */
        .color-purple { background-color: #9370DB; } /* Violet */
        .color-lightgray { background-color: #D3D3D3; } /* Gris clair */
        .color-orange { background-color: #FFA500; } /* Orange */
        .color-lightblue { background-color: #ADD8E6; } /* Bleu clair */
        .color-pink { background-color: #FFC0CB; } /* Rose */
        .color-teal { background-color: #008080; } /* Sarcelle */
        .color-beige { background-color: #F5F5DC; } /* Beige */
        .color-lightgreen { background-color: #90EE90; } /* Vert clair */
        .color-salmon { background-color: #FA8072; } /* Saumon */
        .color-lavender { background-color: #E6E6FA; } /* Lavande */
        .color-mint { background-color: #98FF98; } /* Menthe */
        .color-peach { background-color: #FFDAB9; } /* P√™che */
        .color-skyblue { background-color: #87CEEB; } /* Bleu ciel */
        .color-coral { background-color: #FF7F50; } /* Corail */
        .selected { border: 2px solid black; }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #csvTable, #csvTable * {
                visibility: visible;
            }
            #csvTable {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>√âditeur de fichiers CSV Avanc√©</h1>
        <input type="file" id="csvFile" accept=".csv" />
        <button onclick="addRow()">‚ûï Ajouter une ligne</button>
        <button onclick="deleteColumn()">üóëÔ∏è Supprimer colonne</button>
        <button onclick="deleteEmptyRows()">üßπ Supprimer lignes vides</button>
        <button onclick="mergeCSV()">üîó Fusionner CSV</button>
        <button onclick="detectDuplicates()">üîç D√©tecter les doublons</button>
        <button onclick="exportCSV()">üíæ Exporter CSV</button>
        <button onclick="resetTable()">üîÑ R√©initialiser le tableau</button>
        <button onclick="printTable()">üñ®Ô∏è Imprimer</button>
        <button onclick="exportHTML()">üìÑ Exporter HTML</button>
        <button onclick="mergeCells()">‚öôÔ∏è Fusionner cellules</button>
        <button onclick="undo()">‚Ü©Ô∏è Annuler</button>
        <button onclick="redo()">‚Ü™Ô∏è Refaire</button>
    </div>

    <br><br>

    <label for="searchInput">Rechercher :</label>
    <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="searchTable()">
    <label for="replaceInput">Remplacer :</label>
    <input type="text" id="replaceInput" placeholder="Remplacer..." />
    <button onclick="replaceInTable()">Remplacer</button>

    <br><br>

    <label for="columnSelector">S√©lectionner une colonne :</label>
    <select id="columnSelector">
        <option value="-1">Aucune</option>
    </select>

    <br><br>

    <label>Couleur :</label>
    <div id="colorPalette">
        <div class="color-option color-red" onclick="selectTextColor('red')"></div>
        <div class="color-option color-blue" onclick="selectTextColor('blue')"></div>
        <div class="color-option color-green" onclick="selectTextColor('green')"></div>
        <div class="color-option color-yellow" onclick="selectTextColor('yellow')"></div>
        <div class="color-option color-purple" onclick="selectTextColor('purple')"></div>
        <div class="color-option color-lightgray" onclick="selectTextColor('lightgray')"></div>
        <div class="color-option color-orange" onclick="selectTextColor('orange')"></div>
        <div class="color-option color-lightblue" onclick="selectTextColor('lightblue')"></div>
        <div class="color-option color-pink" onclick="selectTextColor('pink')"></div>
        <div class="color-option color-teal" onclick="selectTextColor('teal')"></div>
        <div class="color-option color-beige" onclick="selectTextColor('beige')"></div>
        <div class="color-option color-lightgreen" onclick="selectTextColor('lightgreen')"></div>
        <div class="color-option color-salmon" onclick="selectTextColor('salmon')"></div>
        <div class="color-option color-lavender" onclick="selectTextColor('lavender')"></div>
        <div class="color-option color-mint" onclick="selectTextColor('mint')"></div>
        <div class="color-option color-peach" onclick="selectTextColor('peach')"></div>
        <div class="color-option color-skyblue" onclick="selectTextColor('skyblue')"></div>
        <div class="color-option color-coral" onclick="selectTextColor('coral')"></div>
    </div>

    <br>

    <label for="rowsPerPage">Lignes par page :</label>
    <input type="number" id="rowsPerPage" value="20" min="1" max="100" />

    <table id="csvTable">
        <thead id="csvHeader"></thead>
        <tbody id="csvBody"></tbody>
    </table>

    <div class="pagination">
        <button onclick="prevPage()">Pr√©c√©dent</button>
        <button onclick="nextPage()">Suivant</button>
    </div>

    <label for="fontSelector">Changer police :</label>
    <select id="fontSelector" onchange="changeFont()">
        <option value="Arial">Arial</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Courier New">Courier New</option>
        <option value="Georgia">Georgia</option>
    </select>

    <br><br>

    <button onclick="boldText()">Mettre en Gras</button>
    <button onclick="italicizeText()">Mettre en Italique</button>
    <button onclick="underlineText()">Souligner</button>

    <br><br>

    <label for="fillColumn">Remplir colonne avec :</label>
    <input type="text" id="fillColumnValue" placeholder="Entrez une valeur" />
    <button onclick="fillColumn()">Remplir</button>
</div>

<script>
    let csvData = [];
    let originalCsvData = [];
    let selectedColumns = {};
    let currentPage = 1;
    let rowsPerPage = 20;
    let rowsToPrint = 20;
    let highlightedCells = new Set();
    let history = [];
    let redoStack = [];

    document.getElementById('rowsPerPage').addEventListener('change', function() {
        rowsPerPage = parseInt(this.value);
        rowsToPrint = parseInt(this.value);
        currentPage = 1;
        paginateTable();
    });

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = function(event) {
            const csv = event.target.result;
            parseCSV(csv);
        };

        reader.readAsText(file);
    });

    function parseCSV(csv) {
        const rows = csv.split('\n').map(row => row.split(','));
        const metaRows = rows.filter(row => row.length <= 2);
        const dataRows = rows.filter(row => row.length > 2);
        csvData = metaRows.concat(dataRows);
        originalCsvData = JSON.parse(JSON.stringify(csvData));
        displayTable();
        populateColumnSelector(dataRows[0].length);
    }

    function displayTable() {
        const tableHeader = document.getElementById('csvHeader');
        const tableBody = document.getElementById('csvBody');

        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        if (csvData.length > 0) {
            const headerRow = document.createElement('tr');
            csvData[0].forEach((cell, index) => {
                const th = document.createElement('th');
                th.textContent = cell;
                th.onclick = () => sortTableByColumn(index);
                headerRow.appendChild(th);
            });
            const thDelete = document.createElement('th');
            thDelete.textContent = 'Actions';
            headerRow.appendChild(thDelete);
            tableHeader.appendChild(headerRow);
        }

        for (let i = 1; i < csvData.length; i++) {
            const row = document.createElement('tr');
            csvData[i].forEach((cell, index) => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.classList.add('editable');
                td.textContent = cell;
                if (selectedColumns[index]) {
                    td.style.backgroundColor = selectedColumns[index];
                }
                row.appendChild(td);
            });

            const deleteButton = document.createElement('td');
            deleteButton.innerHTML = `<button onclick="deleteRow(${i})">Supprimer</button>`;
            row.appendChild(deleteButton);
            tableBody.appendChild(row);
        }

        paginateTable();
    }

    function addRow() {
        // V√©rifie s'il existe au moins une ligne dans csvData pour conna√Ætre le nombre de colonnes
        if (csvData.length > 0) {
            // R√©cup√®re le nombre de colonnes √† partir de la premi√®re ligne
            const columnCount = csvData[0].length;

            // Cr√©e une nouvelle ligne avec le m√™me nombre de colonnes
            const newRow = new Array(columnCount).fill('');

            // Sauvegarder l'√©tat pour permettre annulation
            saveState();

            // Ajoute la nouvelle ligne au tableau CSV
            csvData.push(newRow);

            // Met √† jour l'affichage du tableau
            displayTable();
        } else {
            // Si le tableau est vide, cr√©e une ligne avec un nombre de colonnes par d√©faut, par exemple 6
            const defaultColumnCount = 6;
            const newRow = new Array(defaultColumnCount).fill('');

            saveState();
            csvData.push(newRow);
            displayTable();
        }
    }

    function deleteColumn() {
        const columnSelector = document.getElementById('columnSelector');
        const selectedColIndex = parseInt(columnSelector.value);
        if (selectedColIndex !== -1 && confirm("√ätes-vous s√ªr de vouloir supprimer cette colonne ?")) {
            saveState();
            csvData.forEach(row => row.splice(selectedColIndex, 1));
            displayTable();
        }
    }

    function deleteEmptyRows() {
        saveState();
        csvData = csvData.filter(row => row.some(cell => cell.trim() !== ''));
        displayTable();
    }

    function exportCSV() {
        let csvContent = csvData.map(e => e.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "modified_file.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function resetTable() {
        saveState();
        csvData = JSON.parse(JSON.stringify(originalCsvData));
        selectedColumns = {};
        highlightedCells.clear();
        displayTable();
        resetColorPaletteSelection();
    }

    function saveState() {
        history.push(JSON.parse(JSON.stringify(csvData)));
        redoStack = [];
    }

    function undo() {
        if (history.length > 0) {
            redoStack.push(JSON.parse(JSON.stringify(csvData)));
            csvData = history.pop();
            displayTable();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            history.push(JSON.parse(JSON.stringify(csvData)));
            csvData = redoStack.pop();
            displayTable();
        }
    }

    function populateColumnSelector(numCols) {
        const select = document.getElementById('columnSelector');
        select.innerHTML = '<option value="-1">Aucune</option>';
        for (let i = 0; i < numCols; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Colonne ${i + 1}`;
            select.appendChild(option);
        }
    }

    function selectTextColor(color) {
        const columnSelector = document.getElementById('columnSelector');
        const selectedColIndex = parseInt(columnSelector.value);
        if (selectedColIndex !== -1) {
            selectedColumns[selectedColIndex] = getColorCode(color);
            applyColumnTextColors();
        }
    }

    function getColorCode(color) {
        const colorMap = {
            'red': '#FF6347',
            'blue': '#1E90FF',
            'green': '#32CD32',
            'yellow': '#FFD700',
            'purple': '#9370DB'
        };
        return colorMap[color] || '';
    }

    function applyColumnTextColors() {
        const tableBody = document.getElementById('csvBody');
        tableBody.querySelectorAll('tr').forEach((row, rowIndex) => {
            row.querySelectorAll('td').forEach((cell, colIndex) => {
                if (selectedColumns[colIndex]) {
                    cell.style.color = selectedColumns[colIndex];
                } else {
                    cell.style.color = '';
                }
            });
        });
    }

    function updateColorPaletteSelection(selectedColor) {
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.color-${selectedColor}`).classList.add('selected');
    }

    function resetColorPaletteSelection() {
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
    }

    function paginateTable() {
        const tableBody = document.getElementById('csvBody');
        const totalRows = csvData.length;
        const startIndex = (currentPage - 1) * rowsPerPage + 1;
        const endIndex = Math.min(startIndex + rowsPerPage - 1, totalRows - 1);
        const visibleRows = csvData.slice(startIndex, endIndex + 1);

        tableBody.innerHTML = '';
        visibleRows.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            row.forEach((cell, colIndex) => {
                const td = document.createElement('td');
                td.textContent = cell;
                td.contentEditable = true;
                td.classList.add('editable');
                if (selectedColumns[colIndex]) {
                    td.style.backgroundColor = selectedColumns[colIndex];
                }
                tr.appendChild(td);
            });

            const deleteButton = document.createElement('td');
            deleteButton.innerHTML = `<button onclick="deleteRow(${startIndex + rowIndex})">Supprimer</button>`;
            tr.appendChild(deleteButton);

            tableBody.appendChild(tr);
        });
    }

    function nextPage() {
        const totalRows = csvData.length - 1;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            paginateTable();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            paginateTable();
        }
    }

    function printTable() {
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Impression du tableau</title>');
        printWindow.document.write('<style>table { border-collapse: collapse; width: 100%; } table, th, td { border: 1px solid #ddd; } th, td { padding: 12px; text-align: left; } th { background-color: #4CAF50; color: white; } td { background-color: #f9f9f9; }</style>');
        printWindow.document.write('</head><body>');

        const totalRows = csvData.length - 1;
        const totalPages = Math.ceil(totalRows / rowsToPrint);

        for (let page = 0; page < totalPages; page++) {
            printWindow.document.write('<table><thead>');
            printWindow.document.write('<tr>');
            csvData[0].forEach(header => {
                printWindow.document.write('<th>' + header + '</th>');
            });
            printWindow.document.write('</tr></thead><tbody>');

            const startIndex = page * rowsToPrint + 1;
            const endIndex = Math.min(startIndex + rowsToPrint - 1, csvData.length - 1);

            for (let i = startIndex; i <= endIndex; i++) {
                printWindow.document.write('<tr>');
                csvData[i].forEach((cell, colIndex) => {
                    let tdStyle = '';
                    if (selectedColumns[colIndex]) {
                        tdStyle = `style="background-color:${selectedColumns[colIndex]}"`;
                    }
                    printWindow.document.write('<td ' + tdStyle + '>' + cell + '</td>');
                });
                printWindow.document.write('</tr>');
            }
            printWindow.document.write('</tbody></table>');
            if (page < totalPages - 1) {
                printWindow.document.write('<div style="page-break-after: always;"></div>');
            }
        }

        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }

    function exportHTML() {
        let table = document.getElementById("csvTable");
        let htmlContent = `
            <!DOCTYPE html>
            <html lang="fr">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Export HTML</title>
                <style>
                    table { border-collapse: collapse; width: 100%; }
                    table, th, td { border: 1px solid #ddd; }
                    th, td { padding: 12px; text-align: left; }
                    th { background-color: #4CAF50; color: white; }
                    td { background-color: #f9f9f9; }
                </style>
            </head>
            <body>
                ${table.outerHTML}
            </body>
            </html>
        `;

        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'tableau.html';
        link.click();
        URL.revokeObjectURL(url);
    }

    function deleteRow(rowIndex) {
        saveState();
        csvData.splice(rowIndex, 1);
        displayTable();
    }

    function searchTable() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const tableBody = document.getElementById('csvBody');
        tableBody.querySelectorAll('tr').forEach((row) => {
            const found = Array.from(row.children).some((td) => td.textContent.toLowerCase().includes(searchInput));
            row.style.display = found ? '' : 'none';
        });
    }

    function sortTableByColumn(columnIndex) {
        saveState();
        csvData.sort((a, b) => a[columnIndex].localeCompare(b[columnIndex]));
        displayTable();
    }

    function boldText() {
        document.execCommand('bold');
    }

    function italicizeText() {
        document.execCommand('italic');
    }

    function underlineText() {
        document.execCommand('underline');
    }

    function fillColumn() {
        const columnSelector = document.getElementById('columnSelector');
        const selectedColIndex = parseInt(columnSelector.value);
        const value = document.getElementById('fillColumnValue').value;
        if (selectedColIndex !== -1) {
            saveState();
            csvData.forEach((row, i) => {
                if (i > 0) {
                    row[selectedColIndex] = value;
                }
            });
            displayTable();
        }
    }

    function changeFont() {
        const font = document.getElementById('fontSelector').value;
        document.getElementById('csvBody').style.fontFamily = font;
    }

    function detectDuplicates() {
        let duplicates = [];
        let seen = new Set();
        
        // Parcours du tableau csvData pour d√©tecter les lignes dupliqu√©es
        csvData.forEach((row, index) => {
            let rowString = row.join(','); // Cr√©er une cha√Æne de caract√®res unique pour chaque ligne
            
            if (seen.has(rowString)) {
                duplicates.push(index); // Si la ligne est d√©j√† vue, on l'ajoute comme doublon
            } else {
                seen.add(rowString); // Sinon, on l'ajoute dans l'ensemble des lignes vues
            }
        });

        if (duplicates.length > 0) {
            alert(`Lignes dupliqu√©es trouv√©es aux index : ${duplicates.join(', ')}`);
            highlightDuplicates(duplicates);
        } else {
            alert("Aucun doublon trouv√©.");
        }
    }

    // Fonction pour surligner les lignes dupliqu√©es
    function highlightDuplicates(duplicateIndexes) {
        const tableBody = document.getElementById('csvBody');

        // Supprime d'abord les surlignages existants
        tableBody.querySelectorAll('tr').forEach(row => {
            row.style.backgroundColor = '';
        });

        // Applique un surlignage jaune aux lignes dupliqu√©es
        duplicateIndexes.forEach(index => {
            tableBody.querySelectorAll('tr')[index - 1].style.backgroundColor = 'yellow'; // -1 car le tableau commence √† l'index 1
        });
    }

    function mergeCells() {
        const selectedColIndex = parseInt(document.getElementById('columnSelector').value);
        if (selectedColIndex !== -1) {
            const selectedRowIndex = 1; // Example row for merging
            const cell1 = document.querySelector(`#csvBody tr:nth-child(${selectedRowIndex}) td:nth-child(${selectedColIndex})`);
            const cell2 = document.querySelector(`#csvBody tr:nth-child(${selectedRowIndex + 1}) td:nth-child(${selectedColIndex})`);
            if (cell1 && cell2) {
                saveState();
                cell1.colSpan = 2; // Merge cells
                cell2.remove(); // Remove the second cell
            }
        }
    }
</script>
</body>
</html>
